name: Github Deploy

on:
  push:
    tags:
      - 'v*'  # 仅当推送的是标签时触发工作流

jobs:
  github-release:
    name: Upload to GitHub Release
    runs-on: ubuntu-latest

    permissions:
      contents: write  # 必须权限，用于创建 GitHub Release
      id-token: write  # 必须权限，用于 sigstore

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git fetch --tags  # 确保我们有所有的标签

      - name: Get previous tag
        id: prev_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 $GITHUB_SHA^)
          echo "Previous tag: $PREVIOUS_TAG"
          echo "::set-output name=previous_tag::$PREVIOUS_TAG"

      - name: Get commit history between tags
        id: changes
        run: |
          # 获取两个标签之间的所有提交
          COMMITS=$(git log ${{ steps.prev_tag.outputs.previous_tag }}..$GITHUB_SHA --oneline)
          echo "Commits between ${{ steps.prev_tag.outputs.previous_tag }} and $GITHUB_SHA:"
          echo "$COMMITS"
          echo "::set-output name=commit_changes::$COMMITS"

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        run: |
          gh release create $GITHUB_REF_NAME \
            --repo $GITHUB_REPOSITORY \
            --notes "${{ steps.changes.outputs.commit_changes }}" \
            --prerelease \
            --generate-notes \
            --title "Furious ${{ github.ref_name }}"
