name: Github Deploy  # å®šä¹‰å·¥ä½œæµçš„åç§°

on: [push]
#on:
#  push:
#    tags:
#      - '*'  # ç›‘å¬æ‰€æœ‰æ ‡ç­¾çš„æ¨é€ï¼Œæˆ–è€…å¯ä»¥æ ¹æ®éœ€è¦æŒ‡å®šæ ‡ç­¾æ¨¡å¼ï¼Œå¦‚ 'v*' è¡¨ç¤ºæ‰€æœ‰ä»¥ v å¼€å¤´çš„æ ‡ç­¾

defaults:
  run:
    shell: bash  # é»˜è®¤ä½¿ç”¨ bash ä½œä¸º shell æ¥æ‰§è¡Œå‘½ä»¤

jobs:
  # ä½œä¸š1ï¼šæ„å»ºå¹¶æ‰“åŒ… Python åˆ†å‘åŒ…
  build-distribution:
    name: Build distribution  # è®¾ç½®ä½œä¸šåç§°
    runs-on: ubuntu-latest  # æŒ‡å®šè¿è¡Œç¯å¢ƒä¸ºæœ€æ–°ç‰ˆæœ¬çš„ Ubuntu

    steps:
      # 1. Checkout ä»“åº“ä»£ç 
      - uses: actions/checkout@v4  # ä½¿ç”¨ GitHub å®˜æ–¹çš„ checkout action æ¥æ‹‰å–ä»£ç 

      # 2. ç¼“å­˜ Python ä¾èµ–é¡¹
      - name: Cache Python dependencies
        uses: actions/cache@v3  # ä½¿ç”¨ç¼“å­˜ action æ¥åŠ é€Ÿä¾èµ–å®‰è£…
        with:
          path: ~/.cache/pip  # ç¼“å­˜è·¯å¾„
          key: ${{ runner.os }}-pip-cache-${{ hashFiles('**/requirements.txt') }}  # ç¼“å­˜é”®ï¼Œä¾èµ–æ–‡ä»¶å˜åŒ–æ—¶æ›´æ–°
          restore-keys: |
            ${{ runner.os }}-pip-cache-  # å¤‡ä»½çš„ç¼“å­˜é”®

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4  # ä½¿ç”¨ setup-python action æ¥è®¾ç½® Python ç¯å¢ƒ
        with:
          python-version: "3.12"  # ä½¿ç”¨ Python 3.12
          check-latest: true  # æ£€æŸ¥ Python æ˜¯å¦æ˜¯æœ€æ–°ç‰ˆæœ¬

      # 4. åˆ›å»ºå¹¶æ¿€æ´» Python è™šæ‹Ÿç¯å¢ƒ
      - name: Set up Python venv
        run: |
          python3 -m venv .venv  # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
          source .venv/bin/activate  # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          python3 --version  # æŸ¥çœ‹ Python ç‰ˆæœ¬
          python3 -m pip install --upgrade pip  # å‡çº§ pip

      # 5. å®‰è£…ç³»ç»Ÿä¾èµ–ï¼šlibegl1
#      - name: Install libegl1
#        run: |
#          sudo apt update && sudo apt install -y libegl1  # å®‰è£… libegl1ï¼Œå¯èƒ½æ˜¯ä¾èµ–æŸäº›å›¾å½¢åº“

      # 6. å®‰è£… setuptools å’Œ wheel
      - name: Install setuptools, wheel
        run: |
          python3 -m pip install setuptools wheel  # å®‰è£…æ„å»ºå·¥å…· setuptools å’Œ wheel

      # 7. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install requirements.txt
        run: |
          python3 -m pip install -r requirements.txt  # å®‰è£…é¡¹ç›®ä¾èµ–

      # 8. ä¸‹è½½æœ€æ–°çš„èµ„äº§æ–‡ä»¶
#      - name: Download latest asset files
#        run: |
#          python3 -m pip install requests  # å®‰è£… requests åº“
#          python3 Deploy.py --download  # æ‰§è¡Œè‡ªå®šä¹‰çš„ Deploy.py è„šæœ¬ä¸‹è½½èµ„äº§

      # 9. æ„å»ºæºä»£ç åŒ…å’ŒäºŒè¿›åˆ¶åŒ…
#      - name: Build a binary wheel and a source tarball
#        run: python3 setup.py sdist bdist_wheel  # æ„å»ºæºä»£ç åŒ…å’Œ wheel åŒ…

      # 10. ä¸Šä¼ æ„å»ºçš„åŒ…ä¸ºå·¥ä»¶
#      - name: Store the distribution packages
#        uses: actions/upload-artifact@v3  # ä½¿ç”¨ GitHub çš„ upload-artifact action ä¸Šä¼ æ„å»ºçš„åŒ…
#        with:
#          name: python-package-distributions  # ä¸Šä¼ çš„åŒ…å
#          path: |
#            dist/*.tar.gz  # åŒ…å«æ‰€æœ‰ .tar.gz æ ¼å¼çš„æºä»£ç åŒ…
#            dist/*.whl  # åŒ…å«æ‰€æœ‰ .whl æ ¼å¼çš„äºŒè¿›åˆ¶åŒ…

  # ä½œä¸š2ï¼šå°†åŒ…å‘å¸ƒåˆ° PyPI
  publish-to-pypi:
    name: Publish Python distribution to PyPI  # è®¾ç½®ä½œä¸šåç§°
    # if: startsWith(github.ref, 'refs/tags/')  # only publish to PyPI on tag pushes
    if: false  # è®¾ç½® if ä¸º falseï¼Œè¡¨ç¤ºè¿™ä¸ªä½œä¸šä¸ä¼šæ‰§è¡Œ
    needs:
      - build-distribution  # éœ€è¦ build-distribution ä½œä¸šå…ˆæ‰§è¡Œå®Œæˆ
      - deploy-binaries  # éœ€è¦ deploy-binaries ä½œä¸šå…ˆæ‰§è¡Œå®Œæˆ
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    environment:
      name: deploy-pypi  # ç¯å¢ƒåç§°
      url: https://pypi.org/p/Furious-GUI  # PyPI é¡µé¢é“¾æ¥
    permissions:
      id-token: write  # å¿…é¡»çš„æƒé™ï¼Œå…è®¸å‘ PyPI å‘å¸ƒ

    steps:
      # 1. ä¸‹è½½æ„å»ºçš„åˆ†å‘åŒ…
      - name: Download all the dists
        uses: actions/download-artifact@v3  # ä¸‹è½½å…ˆå‰ä¸Šä¼ çš„åˆ†å‘åŒ…
        with:
          name: python-package-distributions  # ä¸Šä¼ çš„åŒ…å
          path: dist/  # ä¸‹è½½åˆ° dist/ ç›®å½•

      # 2. å°†åˆ†å‘åŒ…å‘å¸ƒåˆ° PyPI
      - name: Publish distribution to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1  # ä½¿ç”¨ PyPI å®˜æ–¹çš„å‘å¸ƒ action

  # ä½œä¸š3ï¼šåœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šéƒ¨ç½²äºŒè¿›åˆ¶æ–‡ä»¶
  deploy-binaries:
    name: Deploy binaries on ${{ matrix.os }}  # è®¾ç½®ä½œä¸šåç§°
    runs-on: ${{ matrix.os }}  # ä½¿ç”¨çŸ©é˜µç­–ç•¥ï¼Œåˆ†åˆ«åœ¨ä¸åŒæ“ä½œç³»ç»Ÿä¸Šè¿è¡Œ
    strategy:
      matrix:
        os: [windows-2022, macos-13, macos-14]  # åœ¨ Windows å’Œ macOS ä¸Šéƒ¨ç½²

    env:
      PYSIDE6_LEGACY_VERSION: "6.4.3"  # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ŒæŒ‡å®šè€ç‰ˆæœ¬çš„ PySide6
      PYSIDE6_TARGET_VERSION: "6.8.1"  # è®¾ç½®ç›®æ ‡ç‰ˆæœ¬çš„ PySide6

    steps:
      # 1. Checkout ä»“åº“ä»£ç 
      - uses: actions/checkout@v4  # ä½¿ç”¨ checkout action æ‹‰å–ä»£ç 

      # 2. ç¼“å­˜ Python ä¾èµ–é¡¹
      - name: Cache Python dependencies
        uses: actions/cache@v3  # ä½¿ç”¨ç¼“å­˜åŠ é€Ÿä¾èµ–å®‰è£…
        with:
          path: ~/.cache/pip  # ç¼“å­˜è·¯å¾„
          key: ${{ runner.os }}-pip-cache-${{ hashFiles('**/requirements.txt') }}  # ç¼“å­˜é”®
          restore-keys: |
            ${{ runner.os }}-pip-cache-  # å¤‡ä»½çš„ç¼“å­˜é”®

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4  # è®¾ç½® Python ç¯å¢ƒ
        with:
          python-version: "3.12"  # ä½¿ç”¨ Python 3.12
          check-latest: true  # æ£€æŸ¥æ˜¯å¦æ˜¯æœ€æ–°ç‰ˆæœ¬

      # 4. åˆ›å»ºå¹¶æ¿€æ´» Python è™šæ‹Ÿç¯å¢ƒ
      - name: Set up Python venv
        run: |
          python3 -m venv .venv  # åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
          if [ "$RUNNER_OS" == "macOS" ]; then
            source .venv/bin/activate  # macOS ä¸Šæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          elif [ "$RUNNER_OS" == "Windows" ]; then
            .venv/Scripts/activate  # Windows ä¸Šæ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
          else
            echo "$RUNNER_OS not supported"  # å¦‚æœæ˜¯å…¶ä»–æ“ä½œç³»ç»Ÿåˆ™é€€å‡º
            exit 1
          fi
          python3 --version  # æŸ¥çœ‹ Python ç‰ˆæœ¬
          python3 -m pip install --upgrade pip  # å‡çº§ pip

#      # 5. å®‰è£… macOS ç‰¹å®šçš„ä¾èµ–
#      - name: Install macOS dependencies
#        run: |
#          brew install create-dmg  # åœ¨ macOS ä¸Šå®‰è£… create-dmg
#        if: runner.os == 'macOS'  # ä»…åœ¨ macOS ä¸Šæ‰§è¡Œ
#
#      # 6. ç§»é™¤ macOS Intel æ¶æ„ä¸Šçš„é—®é¢˜ä¾èµ–
#      - name: Remove problematic brew libs on Intel Mac
#        run: |
#          brew remove --force --ignore-dependencies openssl@3  # ç§»é™¤è¿‡æœŸçš„ OpenSSL åº“
#          brew cleanup openssl@3  # æ¸…ç†ä¾èµ–
#        if: runner.os == 'macOS' && runner.arch == 'X64'  # ä»…åœ¨ Intel æ¶æ„çš„ macOS ä¸Šæ‰§è¡Œ

      # 7. å®‰è£… setuptools å’Œ wheel
      - name: Install setuptools, wheel
        run: |
          python3 -m pip install setuptools wheel  # å®‰è£…æ„å»ºå·¥å…·

      # 8. å®‰è£… PySide6-Essentials
      - name: Install PySide6-Essentials
        run: |
          python3 -m pip install PySide6-Essentials==$PYSIDE6_TARGET_VERSION  # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ PySide6

      # 9. å®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install requirements.txt
        run: |
          python3 -m pip install -r requirements.txt  # å®‰è£…é¡¹ç›®ä¾èµ–
#
#      # 10. å®‰è£… numpy<2
#      - name: Install numpy<2
#        run: |
#          # å®‰è£… numpy ç‰ˆæœ¬å°äº 2 çš„ç‰ˆæœ¬ï¼Œä»¥ç¡®ä¿å…¼å®¹æ€§
#          python3 -m pip install "numpy<2"
#
#      - name: Install nuitka, imageio
#        run: |
#          # å®‰è£… Nuitka å’Œ imageioï¼ŒNuitka ç”¨äºå°† Python ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œimageio ç”¨äºå›¾åƒå¤„ç†
#          python3 -m pip install nuitka imageio
#
#      - name: Set up go 1.20
#        uses: actions/setup-go@v4
#        with:
#          # è®¾ç½® Go è¯­è¨€ç‰ˆæœ¬ä¸º 1.20ï¼Œå¹¶ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
#          go-version: "1.20"
#          check-latest: true
#
#      - name: Install go 1.20 dependencies
#        run: |
#          # å®‰è£… Go è¯­è¨€ç‰ˆæœ¬ 1.20 çš„ä¾èµ–ï¼Œå¹¶éªŒè¯ Go ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®å®‰è£…
#          go version
#          # å®‰è£… hysteria æ¨¡å—çš„ç‰ˆæœ¬å¤§äº 1.3.5
#          python3 -m pip install "hysteria > 1.3.5"
#
#      - name: Set up go 1.23
#        uses: actions/setup-go@v4
#        with:
#          # è®¾ç½® Go è¯­è¨€ç‰ˆæœ¬ä¸º 1.23ï¼Œå¹¶ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
#          go-version: "1.23"
#          check-latest: true
#
#      - name: Install go 1.23 dependencies
#        run: |
#          # å®‰è£… Go è¯­è¨€ç‰ˆæœ¬ 1.23 çš„ä¾èµ–ï¼Œå¹¶éªŒè¯ Go ç‰ˆæœ¬æ˜¯å¦æ­£ç¡®å®‰è£…
#          go version
#          # å®‰è£… Xray-core å’Œ hysteria2 æ¨¡å—ï¼Œç¡®ä¿å®ƒä»¬çš„ç‰ˆæœ¬æ»¡è¶³è¦æ±‚
#          python3 -m pip install "Xray-core >= 1.8.8" "hysteria2 >= 2.0.4" "tun2socks > 2.5.2"


#      - name: Run deploy script
#        run: python3 Deploy.py
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬ï¼Œå¼€å§‹éƒ¨ç½²æœ€æ–°çš„ç‰ˆæœ¬

#      - name: Store the distribution packages
#        uses: actions/upload-artifact@v3
#        with:
#          name: binary-distributions
#          path: |
#            # ä¸Šä¼ äºŒè¿›åˆ¶åˆ†å‘åŒ…åˆ° GitHubï¼Œä»¥ä¾¿åœ¨å‘å¸ƒæ—¶ä½¿ç”¨
#            *.zip
#            *.dmg

  github-release:
    name: >-
      Upload to GitHub Release
    needs:
      - deploy-binaries
      # ä¾èµ–äº deploy-binaries ä½œä¸šï¼Œå³æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½å·²å‡†å¤‡å¥½åæ‰èƒ½æ‰§è¡Œ
      # - publish-to-pypi  # å¦‚æœéœ€è¦å°†å‘å¸ƒå†…å®¹ä¸Šä¼ åˆ° PyPIï¼Œå–æ¶ˆæ­¤è¡Œæ³¨é‡Š
    runs-on: ubuntu-latest
    # åœ¨ Ubuntu æœ€æ–°ç‰ˆæœ¬çš„è™šæ‹Ÿç¯å¢ƒä¸­è¿è¡Œå‘å¸ƒä½œä¸š

    permissions:
      contents: write  # éœ€è¦å†™å…¥ GitHub å†…å®¹åº“æƒé™ï¼Œç”¨äºåˆ›å»ºå‘å¸ƒ
      id-token: write  # éœ€è¦å†™å…¥ id-token æƒé™ï¼Œç”¨äºä¸ GitHub å®‰å…¨åˆä½œ (Sigstore)

    steps:
      # ç¡®ä¿ Git ä»“åº“å·²ç»è¢«æ£€å‡º
      - name: Checkout code
        uses: actions/checkout@v3

      # ä¸‹è½½ä¹‹å‰ä¸Šä¼ åˆ° GitHub Actions çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ†å‘åŒ…
#      - name: Download all the dists
#        uses: actions/download-artifact@v3
#        with:
#          name: binary-distributions
#          path: dist/


      # ä½¿ç”¨ git log è‡ªåŠ¨ç”Ÿæˆ Release Notes
      - name: Generate Release Notes
        id: generate_notes
        run: |
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜ï¼Œä½¿ç”¨ git log ä»ä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„æäº¤ä¿¡æ¯ç”Ÿæˆè¯´æ˜
          echo "## ğŸš€ Release Notes" > release_notes.md
          # ç”Ÿæˆè‡ªä¸Šæ¬¡æ ‡ç­¾ä»¥æ¥çš„æäº¤æ—¥å¿—ï¼Œæ ¼å¼ä¸ºï¼š- commit_message (by author_name)
          git log $(git describe --tags --abbrev=0)..HEAD --reverse --pretty=format:"- %s (by %an)" >> release_notes.md
        shell: bash

      # åœ¨åˆ›å»º Release æ—¶ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„ Release Notes
      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}  # ä½¿ç”¨å½“å‰æ ‡ç­¾å
          release_name: Release ${{ github.ref_name }}  # Release çš„åç§°
          body: ${{ steps.generate_notes.outputs.body }}  # ä½¿ç”¨ç”Ÿæˆçš„ release notes
          draft: false  # è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸æ˜¯è‰ç¨¿
          prerelease: false  # è®¾ç½®ä¸º falseï¼Œè¡¨ç¤ºä¸æ˜¯é¢„å‘å¸ƒ

      - name: Upload artifact to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}  # ä½¿ç”¨ GitHub Secrets ä¸­çš„ RELEASE_TOKEN
        run: >-
          # ä½¿ç”¨ GitHub CLI ä¸Šä¼ æ„å»ºçš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ° GitHub Release
          gh release upload
          '${{ github.ref_name }}' dist/**  # ä½¿ç”¨å½“å‰æ ‡ç­¾ä¸Šä¼ æ‰€æœ‰æ„å»ºçš„æ–‡ä»¶
          --repo '${{ github.repository }}'  # æŒ‡å®šå½“å‰ä»“åº“è¿›è¡Œä¸Šä¼ 